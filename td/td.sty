% Requirement
\RequirePackage{fancyhdr}
\RequirePackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{positioning}
\RequirePackage{xargs}
\RequirePackage{xspace}
\RequirePackage{ifthen}
\newcommand{\fr}[2]{\iflanguage{francais}{#1}{#2}}
%commandes internes au paquet td.sty
\newcommand{\@promo}{None}     %ex. IngéSUP, IngéSPE, Ingé1
\newcommand{\@module}{None}    %ex. Systèmes Techniques, Mathématiques Fondamentales
\newcommand{\@titre}{None}     %ex. 2022-2023
\newcommand{\@tdno}{None}     %ex. 2022-2023
\newcommand{\@logo}{None}
\newcommand{\@esme}{false}
\newcommand{\@corrige}{false}
\newcommand{\@grille}{None}
%main def
\newcommand{\promo}[1]{\renewcommand{\@promo}{#1}}
\newcommand{\module}[1]{\renewcommand{\@module}{#1}}
\newcommand{\titre}[1]{\renewcommand{\@titre}{#1}}
\newcommand{\tdno}[1]{\renewcommand{\@tdno}{#1}}
\newcommand{\logo}[1]{\renewcommand{\@logo}{#1}}
\newcommand{\esme}[1]{\renewcommand{\@esme}{#1}\renewcommand{\@logo}{ESME_LOGO_SEUL_NOIR_2021}}
\newcommand{\corrige}[1]{\renewcommand{\@corrige}{#1}}
\newcommand{\grille}[1]{\renewcommand{\@grille}{#1}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Grille réponse + corrige
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newlength\sizegrid
\newlength\halfgrid
\newcommandx{\reponse}[3][1=1cm,3=]{%
\def\aprescorrige{#3}
\setlength{\sizegrid}{#1}
\setlength{\halfgrid}{0.5\sizegrid}
    % Si on compile le corrigé
    \ifx\@corrige\@true
        % vérifier que l'argument de réponse n'est pas vide.
        \ifthenelse{\equal{#2}{}}{%
            \def\answer{\fr{Aucune réponse n'a été fournie pour cette question.}
                           {No answer was provided for this question.}}
        }{%
            \def\answer{#2}
        }
        % si on utilise une grille, on écrit la réponse sur la grille
        \ifx\@grille\@true
            \begin{tikzpicture}
                \draw[ultra thick,inner sep=0] (0,0) rectangle (\linewidth,\sizegrid);
                \draw[gray!40] (0,0) grid[step=0.5cm] (\linewidth,\sizegrid);
                \node[anchor = center,inner sep=0] at (0.5\linewidth,\halfgrid) {\Large \answer};
            \end{tikzpicture}
        \fi
        % si on n'utilise pas de grille on donne juste la réponse
        \ifx\@grille\@false
            \answer
        \fi
    \fi
    % Si on ne compile pas le corrigé
    \ifx\@corrige\@false
        % on trace la grille réponse
        \ifx\@grille\@true
            \begin{tikzpicture}
                \draw[ultra thick,inner sep=0] (0,0) rectangle (\linewidth,\sizegrid);
                \draw[gray!40](0,0)grid[step=0.5cm](\linewidth,\sizegrid);
            \end{tikzpicture}
        \fi
    \fi
    % si 
    \aprescorrige
}%

\thispagestyle{plain}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\fancyfoot[RO,LE]{\textbf{\thepage}} 
\fancyfoot[RE,LO]{\includegraphics[height=1.25cm]{\@logo}} 
\fancyfoot[C]{\@promo~-~TD~\@tdno~-~\@module}

%Page title
\newcommand\logoIMG{%
    \begin{figure}[!h]
        \centering
        \includegraphics[width=0.25\textwidth]{\@logo}
    \end{figure}
}%
%Exercices/Questions 
\newcounter{numexos}
\newcounter{numques}
\setcounter{numques}{0}
\newcommandx{\question}[2][1=]{%
\addtocounter{numques}{1}
\hfill\break\noindent{\normalfont#1\bfseries Q\thenumques.\xspace\normalfont\normalcolor~#2\\[0.1cm]}
}%
\iflanguage{francais}{%
\newcommand\exercicetitle{Exercice}
}{%
\newcommand\exercicetitle{Exercise}
}%
\newcommandx{\exercice}[2][2=\Large,usedefault]{%
    \setcounter{numques}{0}
    \addtocounter{numexos}{1}
    \ifthenelse{\equal{#1}{}}%
    {\bigskip\noindent{\newline\normalfont#2\bfseries\exercicetitle\,\thenumexos\,}\\[0.2cm]}
    {\bigskip\noindent{\newline\normalfont#2\bfseries\exercicetitle\,\thenumexos\,:\,\,\,#1}\\[0.2cm]}
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\long\def\@true{true}\long\def\@false{false}%
\def\@maketitle{%
  \newpage
  \null
  \vskip 2em%
  \begin{center}%
  \let \footnote \thanks
    \ifthenelse{\equal{\@corrige}{true}}{
        {\LARGE \textsc{\@promo~-~\@module}\\[0.5em]
        \emph{TD~\@tdno~ -- \@titre~\textbf{(Corrigé)}}
        }%
    }{
        {\LARGE \textsc{\@promo~-~\@module}\\[0.5em]
        \emph{TD~\@tdno~ -- \@titre}
        }%
    }%
    \ifthenelse{\equal{\@esme}{true}}{%
    \vskip 0.5em%
    {\large
      \lineskip .5em%
      \begin{tabular}[t]{c}%
        ESME Bordeaux-Lille-Lyon-Paris 
      \end{tabular}\par
    }%
    \vskip 1em%
    }{}%
  \end{center}%
  \par
  \vskip 0.5em
  \thispagestyle{empty}
  \thispagestyle{fancy}\pagenumbering{arabic}\setcounter{page}{1}
}%
